\documentclass[12pt]{article}
\usepackage{amsmath}
\usepackage{bbm}
\usepackage{microtype}
\usepackage[hidelinks]{hyperref}
\usepackage{titlesec}
%usepackage{helvet}
%\renewcommand{\familydefault}{\sfdefault}
%usepackage{setspace}
%\linespread{1.25}
\titlespacing{\section}{0pt}{0pt}{-.5em}
\usepackage[top=1in,bottom=1in,right=1in,left=1in]{geometry}
\setlength{\parindent}{0em}
\setlength{\parskip}{1em}
\newcommand{\ifna}{IFN${\alpha 2}$}
\newcommand{\ifnb}{IFN${\beta}$}
\newcommand{\icFifty}{IC$_{50}$}
\begin{document}
\begin{center}
 \Large\textbf{Bayesian hierarchical regression\\ models of viral properties}
\end{center}
\section*{Summary}
Each viral property, e.g. \ifna{} \icFifty{} or Env/RT ratios, was modeled using a Bayesian hierarchical model.
  The model is based on a linear regression estimating the differences between
  donor plasma viruses and viruses from donor genital fluid or recipient plasma viruses along with the effects of HIV subtype and \ifna{}- and \ifnb{}-selection.
  Unlike a normal linear regression, this model allows accounting for
  1) nested measurements within transmission pairs,
  2) multiple transmissions from a single donor,
  3) heteroscedasticity among virus populations, 
  4) censored data where we only know that a measurement is less than a given value.

These hierarchical models are based on the assumption that observations within a single patient-fluid-treatment
  are independent and identically normally distributed with mean and variance drawn from common population-level distributions.
  Estimates of the population-level distributions can then be used to infer broader patterns in the data.

\section*{Methods}

Data was first transformed as follows:

\begin{table}[ht]
\centering
\begin{tabular}{|l|l|}
      \hline
      Variable                    & Transformation \\ 
      \hline
      Env/RT                      & log            \\ 
      Infectivity                 & log            \\ 
      Replicative capacity        & log            \\ 
      \ifna{} \icFifty{}          & log            \\ 
      \ifnb{} \icFifty{}          & log            \\ 
      \ifna{} Vres (pg/ml)        & logit          \\ 
      \ifnb{} Vres (pg/ml)        & logit          \\ 
      p24 release with \ifna{}    & logit          \\ 
      p24 release without \ifna{} & logit          \\ 
      Autologous \icFifty{}       & log            \\ 
      Bnaber \icFifty{}           & log            \\ 
      \hline
\end{tabular}
\end{table}


The observation from each viral isolate $i$ was then modeled as a normal distribution $N(\mu_i,\sigma^2_i)$ with mean $\mu_i$:
\begin{align*}
  \mu_i&= \text{donor}_{\text{pair}_i} + \beta_{\text{recipient,pair}_i} \mathbbm{1}(\text{recipient}_i) + \beta_{\text{genital,pair}_i} \mathbbm{1}(\text{genital}_i)\\
  &\quad+ \beta_{\text{clade,pair}_i} \mathbbm{1}(\text{cladeB}_i)\mathbbm{1}(\text{recipient}_i) + \beta_{\text{donorAlpha,pair}_i} \mathbbm{1}(\text{donor}_i \text{ \& alphaSelect}_i)\\
  &\quad + \beta_{\text{donorBeta,pair}_i} \mathbbm{1}(\text{donor}_i \text{ \& betaSelect}_i) + \beta_{\text{recipientAlpha,pair}_i} \mathbbm{1}(\text{recipient}_i\text{ \& alphaSelect}_i)\\
  &\quad+ \beta_{\text{recipientBeta,pair}_i} \mathbbm{1}(\text{recipient}_i \text{ \& betaSelect}_i) \\
\end{align*}
and variance $\sigma^2_i$:
\[
  \sigma^2_i = \begin{cases}
    \sigma^2_{\text{genital,pair}_i} & \text{if } \text{genital}_i\\
    \sigma^2_{\text{recipient,pair}_i} & \text{if } \text{recipient}_i\\
    \sigma^2_{\text{donorAlpha,pair}_i} & \text{if } \text{donor}_i \text{ \& alphaSelect}_i\\
    \sigma^2_{\text{donorBeta,pair}_i} & \text{if } \text{donor}_i \text{ \& betaSelect}_i\\
    \sigma^2_{\text{donor,pair}_i} & \text{otherwise}\\
  \end{cases}
\]
where pair$_i$ indicates the pair identity of the $i^\text{th}$ observation,
  $\text{donor}_j$ is the estimated mean of untreated donor plasma viral isolates from pair $j$
  and $\mathbbm{1}()$ is an indicator function that is 1 if True and 0 if False.
  The various $\beta$ are coefficients modeling the change expected for viruses in recipients, in donor genital samples,
  in recipients from HIV clade B and the effects of \ifna{}- or \ifnb{}-selection on donor or recipient viruses.
  So for example, a donor plasma virus $i$ from pair 2 would have mean $\mu_i = \text{donor}_{2}$
  and an \ifna{}-selected recipient virus from pair 3 (which happened to be clade B) would have mean:
\[\mu_i=\text{donor}_{3} + \beta_{\text{recipient,3}} + \beta_{\text{clade,3}} + \beta_{\text{recipientAlpha,3}}\]

For a trio where one donor transmitted viruses to two separate recipients, recipient parameters were estimated independently for each recipient.

In Autologous and Bnaber \icFifty{}, observations less than or equal to 20 were censored at 20 (the maximum amount of plasma tolerated by the cells).
  To model this, the probability of these observations was considered to be:
\[p(\text{\icFifty}=20)=\int_{-\infty}^{\log(20)}N(\mu_i,\sigma^2_i)\]

Vres measurements were calculated as the amount of p24 released under maximum IFN dose divided by the released p24 without IFN as measured by ELISA. The limit of detection on these measurement was 0.1 so concentrations $\leq 0.1$ were measured as 0.1.
  To account for this, the probability of these observations was considered to be:
\[p\left(\text{Vres}=\frac{0.1}{\text{Untreated p24}}\right)=\int_{-\infty}^{\text{logit}\left(\frac{0.1}{\text{Untreated p24}}\right)}N(\mu_i,\sigma^2_i)\]

The coefficients $\beta$ for each pair $j$ come from population-level normal hyperpriors:
\begin{align*}
\text{donor}_{j} & \sim  N(\mu_{\text{donor}},\sigma^2_{\text{donor}})\\
\beta_{\text{recipient},j} & \sim  N(\mu_{\text{recipient}},\sigma^2_{\text{recipient}})\\
\beta_{\text{genital,}j} & \sim  N(\mu_{\text{genital}},\sigma^2_{\text{genital}})\\
\beta_{\text{clade,}j} & \sim  N(\mu_{\text{clade}},\sigma^2_{\text{clade}}) \\
\beta_{\text{donorAlpha,}j} & \sim  N(\mu_{\text{donorAlpha}},\sigma^2_{\text{donorAlpha}}) \\
\beta_{\text{donorBeta,}j} & \sim  N(\mu_{\text{donorBeta}},\sigma^2_{\text{donorBeta}}) \\
\beta_{\text{recipientAlpha,}j} & \sim  N(\mu_{\text{recipientAlpha}},\sigma^2_{\text{recipientAlpha}}) \\
\beta_{\text{recipientBeta,}j} & \sim  N(\mu_{\text{recipientBeta}},\sigma^2_{\text{recipientBeta}}) \\
\end{align*}
and coefficients $\sigma$ from population-level normal hyperpriors:
\begin{align*}
\sigma_{\text{donor,}j} & \sim  N(\theta_\text{donor},\phi^2_\text{donor})\\
\sigma_{\text{donorAlpha,}j} & \sim  N(\theta_\text{donorAlpha},\phi^2_\text{donorAlpha})\\
\sigma_{\text{donorBeta,}j} & \sim  N(\theta_\text{donorBeta},\phi^2_\text{donorBeta})\\
\sigma_{\text{recipient,}j} & \sim  N(\theta_\text{recipient},\phi^2_\text{recipient})\\
\sigma_{\text{genital,}j} & \sim  N(\theta_\text{genital},\phi^2_\text{genital})\\
\end{align*}

The effect hyperparameters
$\mu_{\text{recipient}}$, $\mu_{\text{genital}}$, $\mu_{\text{clade}}$, $\mu_{\text{donorAlpha}}$, $\mu_{\text{donorBeta}}$, $\mu_{\text{recipientAlpha}}$ and $\mu_{\text{recipientBeta}}$ were all given a flat prior probability.
The variance parameters 
$\sigma_{\text{donor}}$, $\sigma_{\text{recipient}}$, $\sigma_{\text{genital}}$, $\sigma_{\text{clade}}$, $\sigma_{\text{donorAlpha}}$, $\sigma_{\text{donorBeta}}$, $\sigma_{\text{recipientAlpha}}$, $\sigma_{\text{recipientAlpha}}$,
$\phi_{\text{donor}}$, $\phi_{\text{donorAlpha}}$, $\phi_{\text{donorBeta}}$, $\phi_{\text{recipient}}$, $\phi_{\text{genital}}$,
$\theta_{\text{donor}}$, $\theta_{\text{donorAlpha}}$, $\theta_{\text{donorBeta}}$, $\theta_{\text{recipient}}$ and $\theta_{\text{genital}}$ 
were given a prior of Gamma(1,2) reflecting prior knowledge that the standard deviation in these assays was unlikely to be greater than several logs.
%For Replicative Capacity, which was modeled on a linear scale, the variance parameters were given a vague prior of Gamma(1,$\frac{1}{100}$).

Plots and statistics are based on the estimated posterior probabilities of the population-level effects
$\mu_{\text{recipient}}$, $\mu_{\text{genital}}$, $\mu_{\text{clade}}$, $\mu_{\text{donorAlpha}}$, $\mu_{\text{donorBeta}}$, $\mu_{\text{recipientAlpha}}$ and $\mu_{\text{recipientBeta}}$.

Markov Chain Monte Carlo sampling of the posterior probability distributions of the models was implemented in Stan using the \texttt{R} package \texttt{rstan}
  and run in 50 chains with each having a 50,000 iteration burnin and 50,000 iterations of sampling every 25$^{\text{th}}$ iteration.
  Code is available at:\\
  \url{https://github.com/sherrillmix/hivPair/blob/master/bayesIC50.R}.

\section{Simple comparison}
As an example of a comparison of the Bayesian estimates with a simpler analysis, we can look at the estimated change in \ifnb{} \icFifty{} between untreated donor plasma viruses and \ifnb-selected donor plasma viruses (Figure 3). We observed $\log_{10}(\text{\icFifty})$ in both untreated and \ifnb-selection viral isolates for 3 donors with averages:
%withAs(xx=hiv[hiv$donor&hiv$select %in% c("UT","BE")&!hiv$isGenital,],tapply(log10(xx$IFNbeta.Pooled.Donor.cells.IC50..pg.ml),list(xx$baseName,xx$select),mean))
\begin{table}[ht]
\centering
  \begin{tabular}{|l|r|r|r|}
    \hline
    Donor  & Untreated & \ifnb{}-selected & Difference \\ 
    \hline
    CH148  & -4.269    & -2.831           & 1.438      \\ 
    CH492  & -4.203    & -2.717           & 1.487      \\ 
    CH596  & -4.162    & -2.820           & 1.343      \\ 
    \hline
  \end{tabular}\\
\end{table}

The simplest estimate would be to take the average, 1.423,
and the standard deviation, 0.0733,
of the three differences and estimate the 95\% confidence interval on the mean as: 
\[1.423\pm \frac{1.96\times 0.0733}{\sqrt{3}}=1.423 \pm 0.0829\]
Or equivalently an estimate that \ifnb-selected donor viruses have an \icFifty{} 26.5$\times$ (95\% confidence interval: 21.9--32.0$\times$) higher than untreated isolates.

From the Bayesian model, we obtained estimates of 20.7$\times$ (95\% credible interval: 11.0--36.2$\times$) higher \icFifty{}.
So the Bayesian model is being more conservative with wider intervals in its estimation due to incorporating uncertainty in our estimates of untreated and \ifnb-selected \icFifty{} for each donor.


\end{document}

